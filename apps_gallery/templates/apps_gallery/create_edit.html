{% extends 'base.html' %}
{% load app_filters %}
{% load static %}

{# 文字エンコーディングを明示的に指定 #}
<meta charset="UTF-8">

{# タイトルブロックを追加 #}
{% block title %}
    {% if app.id %}
        {% if readonly %}
            {{ app.title }} の詳細 | アプリギャラリー
        {% else %}
            {{ app.title }} を編集 | アプリギャラリー
        {% endif %}
    {% else %}
        新規アプリを投稿 | アプリギャラリー
    {% endif %}
{% endblock %}

{# ナビバーを完全に非表示にする #}
{% block navbar %}
{% endblock %}

{# デバッグ用 #}
{{ hide_navbar|default:"not set" }}

{% block content %}
<link rel="stylesheet" href="{% static 'apps_gallery/css/auto-save.css' %}">
<link rel="stylesheet" href="{% static 'apps_gallery/css/cyber-theme.css' %}">

<div class="container-fluid mt-3">
    {% if messages %}
        <div class="row mb-3">
            <div class="col-md-12">
                {% for message in messages %}
                    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-md-12">
            <h2>
                {% if app.id %}
                    {{ app.title }}の編集
                {% else %}
                    新規アプリ作成
                {% endif %}
            </h2>
            
            <!-- 読み取り専用モードの表示 -->
            {% if readonly %}
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle-fill"></i> 読み取り専用モードです。変更はできません。
            </div>
            {% endif %}
        </div>
    </div>

    <!-- アプリ作成フォーム -->
    <form id="appForm" method="post" {% if readonly %}data-readonly="true"{% endif %} {% if app.id %}data-app-id="{{ app.id }}"{% endif %}>
        {% csrf_token %}
        <input type="hidden" name="type" value="{{ active_type }}">
        <input type="hidden" name="user" value="{{ request.user.id }}">
        
        <!-- タブパネル -->
        <ul class="nav nav-tabs mb-3 app-tabs" id="appFormTabs" role="tablist">
            <!-- ホームへ戻るボタン -->
            <li class="nav-item" role="presentation">
                <a href="/" class="nav-link cyber-home" title="ホームへ戻る">
                    <span class="fs-4 me-2 cyber-emoji" style="display: inline-block; font-size: 1.5rem;">&#x1F916;</span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active text-neon" id="screenshots-tab" data-bs-toggle="tab" data-bs-target="#screenshots-section" type="button" role="tab" aria-controls="screenshots-section" aria-selected="true" style="color: var(--cyber-purple) !important; text-shadow: 0 0 10px var(--cyber-purple) !important; border-color: var(--cyber-purple) !important;">スクリーンショット</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-section" type="button" role="tab" aria-controls="basic-section" aria-selected="false" style="color: var(--cyber-gold) !important; text-shadow: 0 0 10px var(--cyber-gold) !important; border-color: var(--cyber-gold) !important;">基本情報</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="appeal-tab" data-bs-toggle="tab" data-bs-target="#appeal-section" type="button" role="tab" aria-controls="appeal-section" aria-selected="false" style="color: var(--cyber-green) !important; text-shadow: 0 0 10px var(--cyber-green) !important; border-color: var(--cyber-green) !important;">アピール</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="hardware-tab" data-bs-toggle="tab" data-bs-target="#hardware-section" type="button" role="tab" aria-controls="hardware-section" aria-selected="false" style="color: var(--cyber-blue) !important; text-shadow: 0 0 10px var(--cyber-blue) !important; border-color: var(--cyber-blue) !important;">ハードウェア</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="dev-env-tab" data-bs-toggle="tab" data-bs-target="#dev-env-section" type="button" role="tab" aria-controls="dev-env-section" aria-selected="false" style="color: var(--cyber-orange) !important; text-shadow: 0 0 10px var(--cyber-orange) !important; border-color: var(--cyber-orange) !important;">開発環境</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="architecture-tab" data-bs-toggle="tab" data-bs-target="#architecture-section" type="button" role="tab" aria-controls="architecture-section" aria-selected="false" style="color: var(--cyber-lime) !important; text-shadow: 0 0 10px var(--cyber-lime) !important; border-color: var(--cyber-lime) !important;">アーキテクチャ</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="backend-tab" data-bs-toggle="tab" data-bs-target="#backend-section" type="button" role="tab" aria-controls="backend-section" aria-selected="false" style="color: var(--cyber-aqua) !important; text-shadow: 0 0 10px var(--cyber-aqua) !important; border-color: var(--cyber-aqua) !important;">バックエンド</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="frontend-tab" data-bs-toggle="tab" data-bs-target="#frontend-section" type="button" role="tab" aria-controls="frontend-section" aria-selected="false" style="color: var(--cyber-pink) !important; text-shadow: 0 0 10px var(--cyber-pink) !important; border-color: var(--cyber-pink) !important;">フロントエンド</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="database-tab" data-bs-toggle="tab" data-bs-target="#database-section" type="button" role="tab" aria-controls="database-section" aria-selected="false" style="color: var(--cyber-emerald) !important; text-shadow: 0 0 10px var(--cyber-emerald) !important; border-color: var(--cyber-emerald) !important;">データベース</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-section" type="button" role="tab" aria-controls="security-section" aria-selected="false" style="color: var(--cyber-red) !important; text-shadow: 0 0 10px var(--cyber-red) !important; border-color: var(--cyber-red) !important;">セキュリティ</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link text-neon" id="development-tab" data-bs-toggle="tab" data-bs-target="#development-section" type="button" role="tab" aria-controls="development-section" aria-selected="false" style="color: var(--cyber-yellow) !important; text-shadow: 0 0 10px var(--cyber-yellow) !important; border-color: var(--cyber-yellow) !important;">開発ストーリー</button>
            </li>
        </ul>

        <!-- タブコンテンツ -->
        <div class="tab-content" id="appFormTabsContent">
            <!-- スクリーンショットタブ -->
            <div class="tab-pane fade show active" id="screenshots-section" role="tabpanel" aria-labelledby="screenshots-tab">
                {% include 'apps_gallery/tabs/01_screenshots_tab.html' %}
            </div>
            
            <!-- 基本情報タブ -->
            <div class="tab-pane fade" id="basic-section" role="tabpanel" aria-labelledby="basic-tab">
                {% include 'apps_gallery/tabs/02_basic_tab.html' %}
            </div>

            <!-- アピールタブ -->
            <div class="tab-pane fade" id="appeal-section" role="tabpanel" aria-labelledby="appeal-tab">
                {% include 'apps_gallery/tabs/03_appeal_tab.html' %}
            </div>

            <!-- ハードウェアタブ -->
            <div class="tab-pane fade" id="hardware-section" role="tabpanel" aria-labelledby="hardware-tab">
                {% include 'apps_gallery/tabs/04_hardware_tab.html' %}
            </div>

            <!-- 開発環境タブ -->
            <div class="tab-pane fade" id="dev-env-section" role="tabpanel" aria-labelledby="dev-env-tab">
                {% include 'apps_gallery/tabs/05_dev_env_tab.html' %}
            </div>

            <!-- アーキテクチャタブ -->
            <div class="tab-pane fade" id="architecture-section" role="tabpanel" aria-labelledby="architecture-tab">
                {% include 'apps_gallery/tabs/06_architecture_tab.html' %}
            </div>

            <!-- バックエンドタブ -->
            <div class="tab-pane fade" id="backend-section" role="tabpanel" aria-labelledby="backend-tab">
                {% include 'apps_gallery/tabs/07_backend_tab.html' %}
            </div>

            <!-- フロントエンドタブ -->
            <div class="tab-pane fade" id="frontend-section" role="tabpanel" aria-labelledby="frontend-tab">
                {% include 'apps_gallery/tabs/08_frontend_tab.html' %}
            </div>

            <!-- データベースタブ -->
            <div class="tab-pane fade" id="database-section" role="tabpanel" aria-labelledby="database-tab">
                {% include 'apps_gallery/tabs/09_database_tab.html' %}
            </div>

            <!-- セキュリティタブ -->
            <div class="tab-pane fade" id="security-section" role="tabpanel" aria-labelledby="security-tab">
                {% include 'apps_gallery/tabs/10_security_tab.html' %}
            </div>

            <!-- 開発ストーリータブ -->
            <div class="tab-pane fade" id="development-section" role="tabpanel" aria-labelledby="development-tab">
                {% include 'apps_gallery/tabs/11_development_tab.html' %}
            </div>
        </div>

        <!-- 送信ボタン -->
        <div class="row mt-4 mb-4">
            <div class="col-md-12 d-flex justify-content-center">
                <!-- ホームボタンはタブナビゲーションに移動したので削除 -->
                <a href="/" class="btn btn-secondary cyber-home" id="homeButton">
                    <span class="fs-4 me-2 cyber-emoji">&#x1F916;</span> ホームに戻る
                </a>
            </div>
        </div>
    </form>
</div>

<!-- 自動保存のJavaScriptファイルを読み込む -->
<script src="{% static 'apps_gallery/js/auto-save.js' %}"></script>

<!-- スクロール時にナビゲーションを隠すためのスクリプト -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const appTabs = document.querySelector('.app-tabs');
        let lastScrollTop = 0;
        
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            // 下にスクロールしたらナビを隠す、上にスクロールしたら表示
            if (scrollTop > lastScrollTop && scrollTop > 150) {
                appTabs.classList.add('hidden');
            } else {
                appTabs.classList.remove('hidden');
            }
            
            lastScrollTop = scrollTop;
        });
    });
</script>
{% endblock %} 
{% comment %}
バックエンドタブのスタイルと内容
{% endcomment %}

<div id="backend" class="container" style="margin: 0 !important; padding: 0 !important; display: block !important; visibility: visible !important;">
    <div class="card border-0 shadow-lg cyber-card" style="background-color: rgba(13, 25, 45, 0.95) !important; border: 2px solid #00bfff !important; box-shadow: 0 0 15px rgba(0, 191, 255, 0.5) !important; display: block !important; visibility: visible !important;">
        <div class="card-body" style="color: #00bfff !important; display: block !important; visibility: visible !important; background-color: rgba(13, 25, 45, 0.95) !important;">
            <h2 class="card-title h3 mb-4 text-cyber-aqua" style="color: #00bfff !important; text-shadow: 0 0 10px #00bfff, 0 0 20px #00bfff !important; display: block !important; visibility: visible !important;">
                <i class="bi bi-server" style="color: #00bfff !important; text-shadow: 0 0 10px #00bfff !important;"></i>
                <span style="color: #00bfff !important; text-shadow: 0 0 10px #00bfff !important; display: inline !important;">バックエンド</span>
            </h2>

            <!-- メイン使用言語 -->
            <div class="mb-4" style="display: block !important; visibility: visible !important;">
                <label class="form-label" style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; display: block !important; visibility: visible !important;">メイン使用言語</label>
                <p class="text-muted small mb-3" style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; display: block !important; visibility: visible !important;">
                    ※主に使用している言語を1つ選択してください
                </p>
                <div class="row g-3" style="display: flex !important; visibility: visible !important;">
                    {% for key, lang_name in BACKEND_LANGUAGES.items %}
                    <div class="col-md-4" style="display: block !important; visibility: visible !important;">
                        <div class="form-check" style="display: block !important; visibility: visible !important;">
                            <input type="radio" 
                                   class="form-check-input backend-radio"
                                   name="backend_main_language"
                                   value="{{ key }}"
                                   {% if key == app.backend.main_language %}checked{% endif %}
                                   {% if readonly %}disabled{% endif %}
                                   style="opacity: 1 !important; background-color: transparent !important; border: 3px solid #00bfff !important; box-shadow: 0 0 10px rgba(0, 191, 255, 0.5) !important; width: 1.2em !important; height: 1.2em !important; position: relative !important; margin-top: 0.3em !important; visibility: visible !important; display: inline-block !important;">
                            
                            <!-- 言語名を直接表示 -->
                            <label class="form-check-label backend-label" 
                                   style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; font-weight: 400 !important; opacity: 1 !important; visibility: visible !important; display: inline-block !important; font-size: 1.1em !important;">
                                {{ lang_name }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- フレームワーク -->
            <div class="mb-4" style="display: block !important; visibility: visible !important;">
                <label class="form-label" style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; display: block !important; visibility: visible !important;">使用フレームワーク</label>
                <p class="text-muted small mb-3" style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; display: block !important; visibility: visible !important;">
                    ※使用しているフレームワークを選択してください
                </p>
                <div class="row g-3" id="frameworksContainer" style="display: flex !important; visibility: visible !important;">
                    <!-- JavaScriptで動的に生成 -->
                </div>
            </div>

            <!-- パッケージ・ライブラリ -->
            <div class="mb-4" style="display: block !important; visibility: visible !important;">
                <label class="form-label" style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; display: block !important; visibility: visible !important;">使用パッケージ・ライブラリ</label>
                <p class="text-muted small mb-3" style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; display: block !important; visibility: visible !important;">
                    ※主要な機能カテゴリを選択してください（複数選択可）
                </p>
                <div class="row g-3" style="display: flex !important; visibility: visible !important;">
                    {% for hint in BACKEND_PACKAGE_HINTS %}
                    <div class="col-md-4" style="display: block !important; visibility: visible !important;">
                        <div class="form-check" style="display: block !important; visibility: visible !important;">
                            <input type="checkbox" 
                                   class="form-check-input"
                                   name="backend_packages"
                                   value="{{ hint }}"
                                   {% if hint in app.backend.packages %}checked{% endif %}
                                   {% if readonly %}disabled{% endif %}
                                   style="opacity: 1 !important; background-color: transparent !important; border: 3px solid #00bfff !important; box-shadow: 0 0 10px rgba(0, 191, 255, 0.5) !important; width: 1.2em !important; height: 1.2em !important; position: relative !important; margin-top: 0.3em !important; visibility: visible !important; display: inline-block !important;">
                            <label class="form-check-label" style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; font-weight: 400 !important; opacity: 1 !important; visibility: visible !important; display: inline-block !important;">{{ hint }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // テンプレートからデータを取得
    try {
        // バックエンドスタックは直接コンスタントから定義
        const backendStack = {
            'python': {
                name: 'Python',
                frameworks: {
                    'django': 'Django',
                    'flask': 'Flask',
                    'fastapi': 'FastAPI',
                    'other': 'その他'
                }
            },
            'php': {
                name: 'PHP',
                frameworks: {
                    'laravel': 'Laravel',
                    'symfony': 'Symfony',
                    'cakephp': 'CakePHP',
                    'other': 'その他'
                }
            },
            'nodejs': {
                name: 'Node.js',
                frameworks: {
                    'express': 'Express',
                    'nestjs': 'NestJS',
                    'fastify': 'Fastify',
                    'other': 'その他'
                }
            },
            'ruby': {
                name: 'Ruby',
                frameworks: {
                    'rails': 'Ruby on Rails',
                    'sinatra': 'Sinatra', 
                    'other': 'その他'
                }
            },
            'java': {
                name: 'Java',
                frameworks: {
                    'spring': 'Spring',
                    'springboot': 'Spring Boot',
                    'other': 'その他'
                }
            },
            'csharp': {
                name: 'C#',
                frameworks: {
                    'dotnet': '.NET',
                    'aspnet': 'ASP.NET',
                    'other': 'その他'
                }
            },
            'golang': {
                name: 'Go',
                frameworks: {
                    'gin': 'Gin',
                    'echo': 'Echo',
                    'other': 'その他'
                }
            },
            'other': {
                name: 'その他',
                frameworks: {
                    'other': 'その他'
                }
            }
        };
        
        // デバッグ用にBACKEND_STACKの構造をコンソールに出力
        console.log('backendStack:', backendStack);
        
        // currentBackendの初期化 - app.backendから直接取得
        let currentBackend = {
            framework: ''
        };
        
        // 既存のデータがあればそれを使用
        const mainLangRadio = document.querySelector('input[name="backend_main_language"]:checked');
        if (mainLangRadio) {
            const selectedLang = mainLangRadio.value;
            console.log('Selected language:', selectedLang);
            
            // フレームワークラジオボタンを探す
            const frameworkRadios = document.querySelectorAll('input[name="backend_framework"]');
            for (let radio of frameworkRadios) {
                if (radio.checked) {
                    currentBackend.framework = radio.value;
                    break;
                }
            }
        }

        // フレームワーク選択の更新関数
        function updateFrameworks(language) {
            const container = document.getElementById('frameworksContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!language || !backendStack[language]) return;
            
            const frameworks = backendStack[language].frameworks;
            
            Object.entries(frameworks).forEach(function(entry) {
                const key = entry[0];
                const name = entry[1];
                const div = document.createElement('div');
                div.className = 'col-md-4';
                div.innerHTML = `
                    <div class="form-check" style="display: block !important; visibility: visible !important;">
                        <input type="radio" 
                               class="form-check-input backend-radio"
                               name="backend_framework"
                               value="${key}"
                               ${currentBackend.framework === key ? 'checked' : ''}
                               {% if readonly %}disabled{% endif %}
                               style="opacity: 1 !important; background-color: transparent !important; border: 3px solid #00bfff !important; box-shadow: 0 0 10px rgba(0, 191, 255, 0.5) !important; width: 1.2em !important; height: 1.2em !important; position: relative !important; margin-top: 0.3em !important; visibility: visible !important; display: inline-block !important;">
                        <label class="form-check-label backend-label"
                               style="color: #00bfff !important; text-shadow: 0 0 5px #00bfff !important; font-weight: 400 !important; opacity: 1 !important; visibility: visible !important; display: inline-block !important; font-size: 1.1em !important;">
                            ${name}
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 初期表示時の処理
        const selectedLanguage = document.querySelector('input[name="backend_main_language"]:checked');
        if (selectedLanguage) {
            updateFrameworks(selectedLanguage.value);
        }

        // フレームワーク選択時の処理
        document.querySelectorAll('input[name="backend_main_language"]').forEach(function(input) {
            input.addEventListener('change', function(e) {
                updateFrameworks(e.target.value);
            });
        });

        // チェックボックスとラジオボタンのカスタマイズ
        document.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked').forEach(function(input) {
            // チェックマークを追加
            const label = input.nextElementSibling;
            if (label) {
                input.style.backgroundColor = "#00bfff";
                input.style.borderColor = "#00bfff";
                
                // 疑似要素の代わりにチェックマークを表示
                const checkmark = document.createElement('span');
                checkmark.textContent = '✓';
                checkmark.style.position = 'absolute';
                checkmark.style.left = '3px';
                checkmark.style.top = '0px';
                checkmark.style.color = 'rgba(13, 25, 45, 0.95)';
                checkmark.style.fontWeight = 'bold';
                
                input.parentNode.style.position = 'relative';
                input.parentNode.insertBefore(checkmark, input.nextSibling);
            }
        });
    } catch (e) {
        console.error('Error parsing backend:', e);
    }
});
</script>
{% endblock %} 
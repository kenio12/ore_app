{% include 'apps_gallery/shared/disabled_styles.html' %}

<div id="development-section" class="container" style="margin: 0 !important; padding: 0 !important;">
    <div class="card border-0 shadow-lg">
        <div class="card-body">
            <h2 class="card-title h3 mb-4">
                <i class="bi bi-code-slash text-cyber-yellow"></i>
                <span class="text-cyber-yellow">開発ストーリー</span>
            </h2>

            <div class="development-inputs">
                <!-- 開発期間 -->
                <div class="mb-4">
                    <label class="form-label text-cyber-yellow">開発期間 <span class="text-danger">*</span></label>
                    <p class="text-muted small mb-3 text-cyber-yellow">
                        ※このアプリケーションの開発期間を入力してください
                    </p>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-cyber-yellow">開始日</label>
                            <input type="date" 
                                   name="development_start_date"
                                   class="form-control cyber-yellow-focus"
                                   value="{{ app.development_story.start_date }}"
                                   {% if readonly %}disabled{% endif %}>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-cyber-yellow">終了日</label>
                            <input type="date" 
                                   name="development_end_date"
                                   class="form-control cyber-yellow-focus"
                                   value="{{ app.development_story.end_date }}"
                                   {% if readonly %}disabled{% endif %}>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div id="development-duration-container" class="cyber-box p-3 text-center">
                            <h4 class="text-cyber-yellow mb-1" id="development-duration">
                                {% if app.development_story.start_date and app.development_story.end_date %}
                                    開発期間: <span id="years"></span>年 <span id="months"></span>ヶ月 <span id="days"></span>日
                                {% else %}
                                    開発期間: 日付を入力してください
                                {% endif %}
                            </h4>
                            <input type="hidden" name="development_duration" id="development_duration_hidden" value="{{ app.development_story.duration }}">
                        </div>
                    </div>
                </div>

                <!-- 開発のきっかけ -->
                <div class="mb-4">
                    <label class="form-label text-cyber-yellow">開発のきっかけ</label>
                    <p class="text-muted small mb-3 text-cyber-yellow">
                        ※このアプリケーションを開発しようと思ったきっかけを詳しく教えてください
                    </p>
                    <textarea name="development_motivation"
                              class="form-control cyber-yellow-focus"
                              rows="6"
                              placeholder="開発のきっかけを記入してください"
                              {% if readonly %}readonly{% endif %}>{% if app.development_story.development_motivation %}{{ app.development_story.development_motivation }}{% endif %}</textarea>
                </div>

                <!-- 開発で工夫した点 -->
                <div class="mb-4">
                    <label class="form-label text-cyber-yellow">開発で工夫した点</label>
                    <p class="text-muted small mb-3 text-cyber-yellow">
                        ※開発中に特に工夫した点や創意工夫したことを詳しく教えてください
                    </p>
                    <textarea name="development_innovations"
                              class="form-control cyber-yellow-focus"
                              rows="6"
                              placeholder="工夫した点を記入してください"
                              {% if readonly %}readonly{% endif %}>{% if app.development_story.development_innovations %}{{ app.development_story.development_innovations }}{% endif %}</textarea>
                </div>

                <!-- 開発で断念した点 -->
                <div class="mb-4">
                    <label class="form-label text-cyber-yellow">開発で断念した点</label>
                    <p class="text-muted small mb-3 text-cyber-yellow">
                        ※当初は実装を目指していたが、時間や技術的制約で断念した機能や特徴を教えてください
                    </p>
                    <textarea name="development_abandoned"
                              class="form-control cyber-yellow-focus"
                              rows="6"
                              placeholder="断念した機能や特徴を記入してください"
                              {% if readonly %}readonly{% endif %}>{% if app.development_story.development_abandoned %}{{ app.development_story.development_abandoned }}{% endif %}</textarea>
                </div>

                <!-- 今後の増設予定 -->
                <div class="mb-4">
                    <label class="form-label text-cyber-yellow">今後の増設予定</label>
                    <p class="text-muted small mb-3 text-cyber-yellow">
                        ※今後追加予定の機能や改善点について教えてください
                    </p>
                    <textarea name="development_future_plans"
                              class="form-control cyber-yellow-focus"
                              rows="6"
                              placeholder="今後の追加予定機能や改善点を記入してください"
                              {% if readonly %}readonly{% endif %}>{% if app.development_story.development_future_plans %}{{ app.development_story.development_future_plans }}{% endif %}</textarea>
                </div>

                <!-- 開発を通して、感じたこと -->
                <div class="mb-4">
                    <label class="form-label text-cyber-yellow">開発を通して、感じたこと</label>
                    <p class="text-muted small mb-3 text-cyber-yellow">
                        ※この開発プロジェクトから学んだことや感じたことをシェアしてください
                    </p>
                    <textarea name="development_reflections"
                              class="form-control cyber-yellow-focus"
                              rows="6"
                              placeholder="開発を通して感じたことを記入してください"
                              {% if readonly %}readonly{% endif %}>{% if app.development_story.development_reflections %}{{ app.development_story.development_reflections }}{% endif %}</textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 基本変数の定義 */
:root {
    --cyber-yellow: #ffd700;
    --cyber-yellow-glow: rgba(255, 215, 0, 0.5);
}

/* カード全体のスタイル */
#development-section .card {
    background: rgba(13, 25, 45, 0.95) !important;
    border: 2px solid var(--cyber-yellow) !important;
    box-shadow: 0 0 15px var(--cyber-yellow-glow) !important;
}

/* セレクトボックスのスタイル */
#development-section .form-select {
    background-color: rgba(13, 25, 45, 0.95) !important;
    color: var(--cyber-yellow) !important;
    border: 2px solid var(--cyber-yellow) !important;
    box-shadow: 0 0 10px var(--cyber-yellow-glow) !important;
}

#development-section .form-select:focus {
    border-color: var(--cyber-yellow) !important;
    box-shadow: 0 0 15px var(--cyber-yellow-glow) !important;
}

/* テキストエリアのスタイル */
#development-section textarea.form-control {
    background-color: rgba(13, 25, 45, 0.95) !important;
    color: var(--cyber-yellow) !important;
    border: 2px solid var(--cyber-yellow) !important;
    box-shadow: 0 0 10px var(--cyber-yellow-glow) !important;
}

/* プレースホルダーのスタイル */
#development-section ::placeholder {
    color: rgba(255, 215, 0, 0.5) !important;
}

/* テキストのスタイル */
#development-section .text-cyber-yellow,
#development-section .form-check-label,
#development-section .cyber-title {
    color: var(--cyber-yellow) !important;
    text-shadow: 0 0 5px var(--cyber-yellow) !important;
    opacity: 1 !important;
    font-weight: 500 !important;
}

/* 説明文のスタイル */
#development-section .text-muted {
    color: var(--cyber-yellow) !important;
    opacity: 0.9 !important;
}

/* disabled状態のスタイル */
#development-section .form-control:disabled,
#development-section .form-select:disabled {
    background-color: rgba(13, 25, 45, 0.95) !important;
    color: var(--cyber-yellow) !important;
    border-color: var(--cyber-yellow) !important;
    opacity: 0.8 !important;
}

/* 開発ストーリータブのスタイル */
#development-section .card-title,
#development-section .text-cyber-yellow {
    color: var(--cyber-yellow) !important;
    text-shadow: 0 0 10px var(--cyber-yellow),
                0 0 20px var(--cyber-yellow) !important;
}

#development-section .form-control,
#development-section .form-select,
#development-section .form-check-input {
    border: 2px solid var(--cyber-yellow) !important;
    color: var(--cyber-yellow) !important;
}

#development-section .form-check-input:checked {
    background-color: var(--cyber-yellow) !important;
    box-shadow: 0 0 10px var(--cyber-yellow) !important;
}

#development-section .form-label,
#development-section .form-check-label,
#development-section .text-muted {
    color: var(--cyber-yellow) !important;
    text-shadow: 0 0 5px var(--cyber-yellow) !important;
}

/* 日付入力フィールドのスタイル */
#development-section input[type="date"] {
    background-color: rgba(13, 25, 45, 0.95) !important;
    border: 2px solid var(--cyber-yellow) !important;
    color: var(--cyber-yellow) !important;
}

/* カレンダーアイコンを黄色に変更 */
#development-section input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(80%) sepia(80%) saturate(1000%) hue-rotate(5deg) brightness(105%) contrast(105%);
    cursor: pointer;
    opacity: 0.8;
}

#development-section input[type="date"]::-webkit-calendar-picker-indicator:hover {
    opacity: 1;
    transform: scale(1.1);
}

/* Firefoxなど他のブラウザ対応 */
#development-section input[type="date"] {
    position: relative;
}

#development-section input[type="date"]::-moz-calendar-picker-indicator {
    background-color: var(--cyber-yellow);
    opacity: 0.8;
}

/* 開発期間表示ボックスのスタイル */
#development-duration-container {
    background: rgba(13, 25, 45, 0.9) !important;
    border: 2px solid var(--cyber-yellow) !important;
    box-shadow: 0 0 15px var(--cyber-yellow-glow) !important;
    position: relative;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

#development-duration-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent 0%, rgba(255, 215, 0, 0.1) 50%, transparent 100%);
    animation: cyber-glow 3s infinite;
}

#development-duration {
    font-weight: bold !important;
    text-shadow: 0 0 10px var(--cyber-yellow), 0 0 20px var(--cyber-yellow) !important;
    position: relative;
    z-index: 1;
}

@keyframes cyber-glow {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
</style>

<script>
// 開発期間を計算して表示するスクリプト
document.addEventListener('DOMContentLoaded', function() {
    initializeDurationCalculator();
});

// タブ切り替え時にも期間計算を実行するため、Bootstrap tabイベントをリッスン
document.addEventListener('shown.bs.tab', function(event) {
    if (event.target.id === 'development-tab') {
        // 開発ストーリータブがアクティブになったら計算を実行
        initializeDurationCalculator();
    }
});

// 期間計算ロジックを初期化する関数
function initializeDurationCalculator() {
    // 開始日と終了日の入力フィールドを取得
    const startDateInput = document.querySelector('input[name="development_start_date"]');
    const endDateInput = document.querySelector('input[name="development_end_date"]');
    
    // 期間表示要素
    const developmentDuration = document.getElementById('development-duration');
    
    // hidden input
    const hiddenDurationInput = document.getElementById('development_duration_hidden');
    
    if (!startDateInput || !endDateInput || !developmentDuration) {
        console.warn('開発期間計算に必要な要素が見つかりません');
        return;
    }
    
    // 初期表示時に開始日と終了日が入力されている場合
    if (startDateInput.value && endDateInput.value) {
        // 既存の値があれば計算して表示
        calculateDuration();
    }
    
    // 期間計算関数
    function calculateDuration() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
            // 開始日と終了日が両方有効な場合のみ計算
            
            // 年月日の計算
            let years = endDate.getFullYear() - startDate.getFullYear();
            let months = endDate.getMonth() - startDate.getMonth();
            let days = endDate.getDate() - startDate.getDate();
            
            // 日が負の場合、前月から借りる
            if (days < 0) {
                months -= 1;
                // 前月の最終日を計算
                const lastDayOfPrevMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 0).getDate();
                days += lastDayOfPrevMonth;
            }
            
            // 月が負の場合、前年から借りる
            if (months < 0) {
                years -= 1;
                months += 12;
            }
            
            // スパン要素に直接数値を表示
            const yearsSpan = document.getElementById('years');
            const monthsSpan = document.getElementById('months');
            const daysSpan = document.getElementById('days');
            
            if (yearsSpan && monthsSpan && daysSpan) {
                yearsSpan.textContent = years;
                monthsSpan.textContent = months;
                daysSpan.textContent = days;
            } else {
                // 結果を表示
                developmentDuration.innerHTML = `開発期間: <span id="years">${years}</span>年 <span id="months">${months}</span>ヶ月 <span id="days">${days}</span>日`;
            }
            
            // インプットフィールドに計算結果も保存
            if (!hiddenDurationInput) {
                // 隠しフィールドを作成
                const newHiddenInput = document.createElement('input');
                newHiddenInput.type = 'hidden';
                newHiddenInput.id = 'development_duration_hidden';
                newHiddenInput.name = 'development_duration';
                newHiddenInput.value = `${years}年${months}ヶ月${days}日`;
                startDateInput.parentNode.parentNode.appendChild(newHiddenInput);
            } else {
                // 既存の隠しフィールドを更新
                hiddenDurationInput.value = `${years}年${months}ヶ月${days}日`;
            }
        } else {
            // どちらかの日付が無効な場合
            developmentDuration.textContent = '開発期間: 日付を入力してください';
        }
    }
    
    // 日付入力時に期間を計算
    startDateInput.addEventListener('change', calculateDuration);
    endDateInput.addEventListener('change', calculateDuration);
    
    // 自動保存後も期間計算を更新するため、inputイベントもリッスン
    startDateInput.addEventListener('input', calculateDuration);
    endDateInput.addEventListener('input', calculateDuration);
    
    // 初期表示時にも計算実行
    calculateDuration();
}
</script> 